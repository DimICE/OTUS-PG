# Домашнее задание
## Работа с журналами
### Цель:
* уметь работать с журналами и контрольными точками
* уметь настраивать параметры журналов
---
> 1. Настройте выполнение контрольной точки раз в 30 секунд.

Установим настройку и перезагрузим конфигурацию: 
```
sudo -u postgres psql
ALTER SYSTEM SET checkpoint_timeout = '30s';
select pg_reload_conf();
SELECT pg_current_wal_insert_lsn();
```
> 2. 10 минут c помощью утилиты pgbench подавайте нагрузку.

С помощью pg_current_wal_insert_lsn() получили текущую позицию добавления в журнале предзаписи (6/A1A31E08).
Запускаем pgbench:
```
sudo su postgres
pgbench -i
pgbench -c8 -P 30 -T 600 postgres
```
> 3. Измерьте, какой объем журнальных файлов был сгенерирован за это время. Оцените, какой объем приходится в среднем на одну контрольную точку.

С помощью pg_current_wal_insert_lsn() снова получаем текущую позицию добавления в журнале предзаписи (6/FB4117A8) и считаем разницу:
```
psql
SELECT pg_current_wal_insert_lsn();
SELECT pg_size_pretty('6/FB4117A8'::pg_lsn - '6/A1A31E08'::pg_lsn);
```
За 10 минут получился объем 1434 MB.
1434 / 20 = по 71,7 MB на одну контрольную точку.

> 4. Проверьте данные статистики: все ли контрольные точки выполнялись точно по расписанию. Почему так произошло?

В логах видно, что контрольные точки во время выполнения pgbench создавались каждые 30 секунд, т.е. по расписанию:
```
2023-06-27 17:34:52.089 UTC [792] СООБЩЕНИЕ:  контрольная точка завершена: записано буферов: 3643 (22.2%); добавлено файлов WAL 0, удалено: 6, переработано: 0; запись=26.960 сек., синхр.=0.0
2023-06-27 17:35:25.122 UTC [792] СООБЩЕНИЕ:  начата контрольная точка: time
2023-06-27 17:35:52.073 UTC [792] СООБЩЕНИЕ:  контрольная точка завершена: записано буферов: 2124 (13.0%); добавлено файлов WAL 0, удалено: 2, переработано: 0; запись=26.944 сек., синхр.=0.0
2023-06-27 17:35:55.074 UTC [792] СООБЩЕНИЕ:  начата контрольная точка: time
2023-06-27 17:36:22.031 UTC [792] СООБЩЕНИЕ:  контрольная точка завершена: записано буферов: 2826 (17.2%); добавлено файлов WAL 0, удалено: 6, переработано: 0; запись=26.947 сек., синхр.=0.0
2023-06-27 17:36:25.034 UTC [792] СООБЩЕНИЕ:  начата контрольная точка: time
2023-06-27 17:36:52.097 UTC [792] СООБЩЕНИЕ:  контрольная точка завершена: записано буферов: 3171 (19.4%); добавлено файлов WAL 0, удалено: 3, переработано: 2; запись=27.053 сек., синхр.=0.0
2023-06-27 17:36:55.098 UTC [792] СООБЩЕНИЕ:  начата контрольная точка: time
2023-06-27 17:37:22.060 UTC [792] СООБЩЕНИЕ:  контрольная точка завершена: записано буферов: 2828 (17.3%); добавлено файлов WAL 0, удалено: 1, переработано: 5; запись=26.948 сек., синхр.=0.0
2023-06-27 17:37:25.063 UTC [792] СООБЩЕНИЕ:  начата контрольная точка: time
2023-06-27 17:37:52.025 UTC [792] СООБЩЕНИЕ:  контрольная точка завершена: записано буферов: 3421 (20.9%); добавлено файлов WAL 0, удалено: 0, переработано: 5; запись=26.957 сек., синхр.=0.0
2023-06-27 17:37:55.028 UTC [792] СООБЩЕНИЕ:  начата контрольная точка: time
2023-06-27 17:38:22.084 UTC [792] СООБЩЕНИЕ:  контрольная точка завершена: записано буферов: 2573 (15.7%); добавлено файлов WAL 0, удалено: 0, переработано: 4; запись=27.052 сек., синхр.=0.0
2023-06-27 17:38:25.086 UTC [792] СООБЩЕНИЕ:  начата контрольная точка: time
2023-06-27 17:38:52.046 UTC [792] СООБЩЕНИЕ:  контрольная точка завершена: записано буферов: 3272 (20.0%); добавлено файлов WAL 0, удалено: 0, переработано: 4; запись=26.953 сек., синхр.=0.0
2023-06-27 17:38:55.050 UTC [792] СООБЩЕНИЕ:  начата контрольная точка: time
2023-06-27 17:39:22.008 UTC [792] СООБЩЕНИЕ:  контрольная точка завершена: записано буферов: 2582 (15.8%); добавлено файлов WAL 0, удалено: 1, переработано: 4; запись=26.951 сек., синхр.=0.0
2023-06-27 17:39:25.010 UTC [792] СООБЩЕНИЕ:  начата контрольная точка: time
2023-06-27 17:39:52.079 UTC [792] СООБЩЕНИЕ:  контрольная точка завершена: записано буферов: 2992 (18.3%); добавлено файлов WAL 0, удалено: 0, переработано: 4; запись=27.053 сек., синхр.=0.0
2023-06-27 17:39:55.082 UTC [792] СООБЩЕНИЕ:  начата контрольная точка: time
2023-06-27 17:40:22.044 UTC [792] СООБЩЕНИЕ:  контрольная точка завершена: записано буферов: 2563 (15.6%); добавлено файлов WAL 0, удалено: 0, переработано: 4; запись=26.944 сек., синхр.=0.0
2023-06-27 17:40:25.046 UTC [792] СООБЩЕНИЕ:  начата контрольная точка: time
2023-06-27 17:40:52.006 UTC [792] СООБЩЕНИЕ:  контрольная точка завершена: записано буферов: 3118 (19.0%); добавлено файлов WAL 0, удалено: 0, переработано: 4; запись=26.954 сек., синхр.=0.0
2023-06-27 17:40:56.006 UTC [792] СООБЩЕНИЕ:  начата контрольная точка: time
2023-06-27 17:41:23.074 UTC [792] СООБЩЕНИЕ:  контрольная точка завершена: записано буферов: 2609 (15.9%); добавлено файлов WAL 0, удалено: 0, переработано: 5; запись=27.052 сек., синхр.=0.0
2023-06-27 17:41:26.077 UTC [792] СООБЩЕНИЕ:  начата контрольная точка: time
2023-06-27 17:41:53.048 UTC [792] СООБЩЕНИЕ:  контрольная точка завершена: записано буферов: 3037 (18.5%); добавлено файлов WAL 0, удалено: 0, переработано: 4; запись=26.955 сек., синхр.=0.0
2023-06-27 17:41:56.050 UTC [792] СООБЩЕНИЕ:  начата контрольная точка: time
2023-06-27 17:42:23.007 UTC [792] СООБЩЕНИЕ:  контрольная точка завершена: записано буферов: 2592 (15.8%); добавлено файлов WAL 0, удалено: 0, переработано: 4; запись=26.951 сек., синхр.=0.0
2023-06-27 17:42:26.010 UTC [792] СООБЩЕНИЕ:  начата контрольная точка: time
2023-06-27 17:42:53.076 UTC [792] СООБЩЕНИЕ:  контрольная точка завершена: записано буферов: 4539 (27.7%); добавлено файлов WAL 0, удалено: 0, переработано: 4; запись=27.058 сек., синхр.=0.0
2023-06-27 17:42:56.079 UTC [792] СООБЩЕНИЕ:  начата контрольная точка: time
2023-06-27 17:43:23.038 UTC [792] СООБЩЕНИЕ:  контрольная точка завершена: записано буферов: 2602 (15.9%); добавлено файлов WAL 0, удалено: 1, переработано: 4; запись=26.951 сек., синхр.=0.0
2023-06-27 17:43:26.038 UTC [792] СООБЩЕНИЕ:  начата контрольная точка: time
2023-06-27 17:43:53.012 UTC [792] СООБЩЕНИЕ:  контрольная точка завершена: записано буферов: 3064 (18.7%); добавлено файлов WAL 0, удалено: 0, переработано: 4; запись=26.956 сек., синхр.=0.0
2023-06-27 17:43:56.014 UTC [792] СООБЩЕНИЕ:  начата контрольная точка: time
2023-06-27 17:44:23.073 UTC [792] СООБЩЕНИЕ:  контрольная точка завершена: записано буферов: 2608 (15.9%); добавлено файлов WAL 0, удалено: 0, переработано: 4; запись=27.051 сек., синхр.=0.0
2023-06-27 17:44:26.074 UTC [792] СООБЩЕНИЕ:  начата контрольная точка: time
2023-06-27 17:44:53.033 UTC [792] СООБЩЕНИЕ:  контрольная точка завершена: записано буферов: 4590 (28.0%); добавлено файлов WAL 0, удалено: 0, переработано: 4; запись=26.951 сек., синхр.=0.0
2023-06-27 17:44:56.036 UTC [792] СООБЩЕНИЕ:  начата контрольная точка: time
2023-06-27 17:45:23.072 UTC [792] СООБЩЕНИЕ:  контрольная точка завершена: записано буферов: 2624 (16.0%); добавлено файлов WAL 0, удалено: 0, переработано: 5; запись=27.020 сек., синхр.=0.0
2023-06-27 17:46:26.135 UTC [792] СООБЩЕНИЕ:  начата контрольная точка: time
2023-06-27 17:46:53.093 UTC [792] СООБЩЕНИЕ:  контрольная точка завершена: записано буферов: 2937 (17.9%); добавлено файлов WAL 0, удалено: 0, переработано: 3; запись=26.945 сек., синхр.=0.0
```
> 5. Сравните tps в синхронном/асинхронном режиме утилитой pgbench. Объясните полученный результат.

```
psql
ALTER SYSTEM SET synchronous_commit = 'on';
select pg_reload_conf();
pgbench -c8 -P 30 -T 60 postgres

psql
ALTER SYSTEM SET synchronous_commit = 'off';
select pg_reload_conf();
pgbench -c8 -P 30 -T 60 postgres
```
В синхоронном:  
tps = 3825.520787 (without initial connection time)

В асинхронном:  
tps = 6656.923816 (without initial connection time)

В асинхронном почти в 2 раза быстрее, это объясняется тем, что в синхнронном режиме PG дожидается подтверждения записи на диск, а в асинхронном нет.

> 6. Создайте новый кластер с включенной контрольной суммой страниц.   
> Создайте таблицу. Вставьте несколько значений.  
> Выключите кластер. Измените пару байт в таблице.  
> Включите кластер и сделайте выборку из таблицы.  
> Что и почему произошло?  
> Как проигнорировать ошибку и продолжить работу?


```
sudo pg_createcluster 15 new -- --data-checksums
sudo pg_ctlcluster 15 new start
sudo -u postgres psql -p 5433
create table test (i int);
insert into test values (1),(2),(3);
SELECT pg_relation_filepath('test');
sudo -u postgres pg_ctlcluster 15 new stop
```
С помощью pg_relation_filepath получили расположение таблицы - base/5/16388.
Изменяем файл /var/lib/postgresql/15/new/base/5/16388, включаем снова кластер и пробуем сделать выборку:
```
sudo -u postgres dd if=/dev/zero of=/var/lib/postgresql/15/new/base/5/16388 oflag=dsync conv=notrunc bs=1 count=8
sudo -u postgres pg_ctlcluster 15 new start
sudo -u postgres psql -p 5433
select * from test;
```
Получаем ошибку:
```
ПРЕДУПРЕЖДЕНИЕ:  ошибка проверки страницы: получена контрольная сумма 54212, а ожидалась - 33473
ОШИБКА:  неверная страница в блоке 0 отношения base/5/16388
```
Чтобы проигнорировать ошибку можно использовать настройку ignore_checksum_failure:
```
SET ignore_checksum_failure = on;
select * from test;
```
после чего выборка из таблицы выполняется успешно.